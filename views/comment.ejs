<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Qu·∫£n l√Ω b√¨nh lu·∫≠n</title>

    <!-- Google Font: Source Sans Pro -->

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css" />
    <!-- Ionicons -->
    <link
      rel="stylesheet"
      href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"
    />
    <!-- Tempusdominus Bootstrap 4 -->
    <link
      rel="stylesheet"
      href="/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css"
    />
    <!-- iCheck -->
    <link
      rel="stylesheet"
      href="/plugins/icheck-bootstrap/icheck-bootstrap.min.css"
    />
    <!-- JQVMap -->
    <link rel="stylesheet" href="/plugins/jqvmap/jqvmap.min.css" />
    <!-- Theme style -->
    <link rel="stylesheet" href="/dist/css/adminlte.min.css" />
    <!-- overlayScrollbars -->
    <link
      rel="stylesheet"
      href="/plugins/overlayScrollbars/css/OverlayScrollbars.min.css"
    />
    <!-- Daterange picker -->
    <link
      rel="stylesheet"
      href="/plugins/daterangepicker/daterangepicker.css"
    />
    <!-- summernote -->
    <link rel="stylesheet" href="/plugins/summernote/summernote-bs4.min.css" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
      .user-panel .info {
        display: flex;
        justify-content: center;
        /* Canh gi·ªØa ngang */
        align-items: center;
        /* Canh gi·ªØa d·ªçc */
        height: 100%;
        /* ƒê·∫£m b·∫£o ph·∫ßn t·ª≠ con chi·∫øm h·∫øt chi·ªÅu cao */
      }

      .user-panel .admin-name {
        font-size: 22px;
        /* TƒÉng k√≠ch th∆∞·ªõc ch·ªØ */
        font-weight: bold;
        /* In ƒë·∫≠m */
        color: white;
        /* Ch·ªØ m√†u tr·∫Øng */
      }

      body {
        background-color: #f4f6f9;
      }

      .card {
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .btn {
        border-radius: 5px;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css"
    />

    <!-- FontAwesome -->
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
      <!-- Preloader -->
      <div
        class="preloader flex-column justify-content-center align-items-center"
      >
        <img
          class="animation__shake"
          src="/uploads/logo.png"
          alt="AdminLTELogo"
          height="60"
          width="60"
        />
      </div>

      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="/v1/dashboard/" class="nav-link">Trang ch·ªß</a>
          </li>
          <li class="nav-item">
            <a href="/v1/dashboard/chat" class="nav-link">Ph·∫£n H·ªìi</a>
          </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
          <!-- Navbar Search -->
          <li class="nav-item">
            <a
              class="nav-link"
              data-widget="navbar-search"
              href="#"
              role="button"
            >
              <i class="fas fa-search"></i>
            </a>
            <div class="navbar-search-block">
              <form class="form-inline">
                <div class="input-group input-group-sm">
                  <input
                    class="form-control form-control-navbar"
                    type="search"
                    placeholder="Search"
                    aria-label="Search"
                  />
                  <div class="input-group-append">
                    <button class="btn btn-navbar" type="submit">
                      <i class="fas fa-search"></i>
                    </button>
                    <button
                      class="btn btn-navbar"
                      type="button"
                      data-widget="navbar-search"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </li>

          <!-- Notifications Dropdown Menu -->
          <li id="nav-notif" class="nav-item dropdown">
            <a
              class="nav-link"
              data-toggle="dropdown"
              href="#"
              aria-expanded="false"
            >
              <i class="far fa-bell"></i>
              <span id="notif-badge" class="badge badge-warning navbar-badge"
                >0</span
              >
            </a>
            <div
              id="notif-menu"
              class="dropdown-menu dropdown-menu-lg dropdown-menu-right p-0"
            >
              <div class="px-3 py-2 border-bottom">
                <strong id="notif-header">0 Notifications</strong>
              </div>
              <div
                id="notif-items"
                style="max-height: 300px; overflow-y: auto"
              ></div>
              <div class="dropdown-divider m-0"></div>
              <a href="#" id="mark-all-read" class="dropdown-item text-center"
                >ƒê√°nh d·∫•u t·∫•t c·∫£ l√† ƒë√£ ƒë·ªçc</a
              >
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
              <i class="fas fa-expand-arrows-alt"></i>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              data-widget="control-sidebar"
              data-controlsidebar-slide="true"
              href="#"
              role="button"
            >
              <i class="fas fa-th-large"></i>
            </a>
          </li>
        </ul>
      </nav>
      <!-- /.navbar -->

      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a class="brand-link">
          <img
            src="/uploads/logo.png"
            alt="Admin Logo"
            class="brand-image img-circle elevation-3 bg-white"
            style="max-width: 150px"
          />
          <span class="brand-text font-weight-light">Clothique</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Sidebar user panel (optional) -->
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="info">
              <div class="admin-name">Ch·ªß C·ª≠a H√†ng</div>
            </div>
          </div>

          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->

                        <li class="nav-item menu-open">
                            <a href="#" class="nav-link active">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>
                                    Trung T√¢m ƒêi·ªÅu Khi·ªÉn
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="/v1/dashboard/products" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>Qu·∫£n l√Ω s·∫£n ph·∫©m</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/v1/dashboard/categories"
                                        class="nav-link <%= currentPath === '/categories' ? 'active' : '' %>">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>Qu·∫£n l√Ω lo·∫°i s·∫£n ph·∫©m</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/v1/dashboard/orders" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>Qu·∫£n l√Ω ƒë∆°n h√†ng</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/v1/dashboard/transactions" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>Qu·∫£n l√Ω h√≥a ƒë∆°n</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/v1/dashboard/coupons"
                                      class="nav-link">
                                      <i class="far fa-circle nav-icon"></i>
                                      <p>Qu·∫£n l√Ω m√£ gi·∫£m gi√°</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/v1/dashboard/users"
                                        class="nav-link <%= currentPath === '/users' ? 'active' : '' %>">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/v1/dashboard/comment"
                                        class="nav-link <%= currentPath === '/comment' ? 'active' : '' %>">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>Qu·∫£n l√Ω b√¨nh lu·∫≠n</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link text-white">
                                <i class="nav-icon fas fa-user"></i>
                                <p>
                                    T√†i Kho·∫£n
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="/v1/dashboard/logout" class="nav-link text-danger">
                                        <i class="nav-icon fas fa-sign-out-alt"></i>
                                        <p>ƒêƒÉng xu·∫•t</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                </nav>
                <!-- /.sidebar-menu -->
            </div>
            <!-- /.sidebar -->
        </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6"></div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->
        <div class="container-fluid">
          <h2 class="text-center">Qu·∫£n l√Ω B√¨nh lu·∫≠n</h2>
          <div class="card p-3">
            <table id="commentsTable" class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>S·∫£n ph·∫©m</th>
                  <th>Ng∆∞·ªùi d√πng</th>
                  <th>Th√≠ch</th>
                  <th>Kh√¥ng th√≠ch</th>
                  <th>H√†nh ƒë·ªông</th>
                  <!-- G·ªôp "B√¨nh lu·∫≠n" v√†o ƒë√¢y -->
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody>
                <% comments.forEach((comment, index)=> { %>
                <tr>
                  <td><%= index + 1 %></td>
                  <td>
                    <%= comment.productId ? comment.productId.name : "Kh√¥ng x√°c ƒë·ªãnh" %>
                  </td>
                  <td>
                    <%= comment.userId ? comment.userId.name : "Kh√¥ng x√°c ƒë·ªãnh"
                    %>
                  </td>
                  <td><%= comment.likes %></td>
                  <td><%= comment.dislikes %></td>
                  <td>
                    <!-- N√∫t X√≥a -->
                    <!-- N√∫t Tr·∫£ l·ªùi (M·ªü modal b√¨nh lu·∫≠n) -->
                    <i
                      class="fas fa-reply text-primary view-comments-btn ms-3 ml-3"
                      data-comment-id="<%= comment._id %>"
                    ></i>
                  </td>
                  <td>
                    <% if (comment.hidden) { %>
                    <span class="badge badge-secondary">ƒê√£ ·∫©n</span>
                    <button
                      class="btn btn-sm btn-success toggle-visibility"
                      data-id="<%= comment._id %>"
                      data-status="false"
                    >
                      Hi·ªán
                    </button>
                    <% } else { %>
                    <span class="badge badge-success">ƒêang hi·ªÉn th·ªã</span>
                    <button
                      class="btn btn-sm btn-warning toggle-visibility"
                      data-id="<%= comment._id %>"
                      data-status="true"
                    >
                      ·∫®n
                    </button>
                    <% } %>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modal hi·ªÉn th·ªã ph·∫£n h·ªìi -->
      <div
        class="modal fade"
        id="replyModal"
        tabindex="-1"
        aria-labelledby="replyModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="replyModalLabel">
                Ph·∫£n h·ªìi b√¨nh lu·∫≠n
              </h5>
            </div>
            <div class="modal-body">
              <div id="commentContent"></div>
              <!-- Hi·ªÉn th·ªã n·ªôi dung b√¨nh lu·∫≠n -->
              <hr />
              <h6>Danh s√°ch ph·∫£n h·ªìi:</h6>
              <ul id="replyList" class="list-group mb-3"></ul>

              <h6>Ph·∫£n h·ªìi m·ªõi:</h6>
              <textarea
                id="replyContent"
                class="form-control"
                rows="3"
                placeholder="Nh·∫≠p ph·∫£n h·ªìi..."
              ></textarea>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
              <button type="button" class="btn btn-primary" id="sendReply">
                G·ª≠i ph·∫£n h·ªìi
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Control Sidebar -->
      <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
      </aside>
      <!-- /.control-sidebar -->
    </div>
    <!-- ./wrapper -->
    <script>
      // ƒêi·ªÅu khi·ªÉn vi·ªác hi·ªÉn th·ªã ph·∫ßn chat khi click v√†o "Ph·∫£n H·ªìi"
      document
        .querySelector('a[href="#chatSection"]')
        .addEventListener("click", function (e) {
          e.preventDefault(); // Ng·ª´ng h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa link
          const chatSection = document.getElementById("chatSection");

          if (
            chatSection.style.display === "none" ||
            chatSection.style.display === ""
          ) {
            chatSection.style.display = "block"; // Hi·ªÉn th·ªã chat
          } else {
            chatSection.style.display = "none"; // ·∫®n chat
          }
        });
    </script>
    <!-- jQuery -->
    <script src="/plugins/jquery/jquery.min.js"></script>
    <!-- jQuery UI 1.11.4 -->
    <script src="/plugins/jquery-ui/jquery-ui.min.js"></script>
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
      $.widget.bridge("uibutton", $.ui.button);
    </script>
    <!-- Bootstrap 4 -->
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- ChartJS -->
    <script src="/plugins/chart.js/Chart.min.js"></script>
    <!-- Sparkline -->
    <script src="/plugins/sparklines/sparkline.js"></script>
    <!-- JQVMap -->
    <script src="/plugins/jqvmap/jquery.vmap.min.js"></script>
    <script src="/plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
    <!-- jQuery Knob Chart -->
    <script src="/plugins/jquery-knob/jquery.knob.min.js"></script>
    <!-- daterangepicker -->
    <script src="/plugins/moment/moment.min.js"></script>
    <script src="/plugins/daterangepicker/daterangepicker.js"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <!-- Summernote -->
    <script src="/plugins/summernote/summernote-bs4.min.js"></script>
    <!-- overlayScrollbars -->
    <script src="/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
    <!-- AdminLTE App -->
    <script src="/dist/js/adminlte.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script>
      $(document).ready(function () {
        let table = $("#commentsTable").DataTable();
        if ($.fn.DataTable.isDataTable("#commentsTable")) {
          table.destroy();
        }

        $("#commentsTable").DataTable({
          autoWidth: false,
          columnDefs: [
            { orderable: false, targets: [4] }, // C·∫≠p nh·∫≠t s·ªë c·ªôt ƒë√∫ng
          ],
          language: {
            lengthMenu: "Hi·ªÉn th·ªã _MENU_ b√¨nh lu·∫≠n m·ªói trang",
            zeroRecords: "Kh√¥ng c√≥ b√¨nh lu·∫≠n n√†o",
            info: "Trang _PAGE_ tr√™n _PAGES_",
            infoEmpty: "Kh√¥ng c√≥ d·ªØ li·ªáu",
            search: "T√¨m ki·∫øm:",
            paginate: {
              first: "ƒê·∫ßu",
              last: "Cu·ªëi",
              next: "Ti·∫øp",
              previous: "Tr∆∞·ªõc",
            },
          },
        });

        $(document).on("click", ".toggle-visibility", function () {
          const commentId = $(this).data("id");
          const newStatus = $(this).data("status"); // true ho·∫∑c false

          fetch(`/v1/dashboard/comment/hide/${commentId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ hidden: newStatus }),
          })
            .then((res) => res.json())
            .then((data) => {
              Swal.fire("Th√†nh c√¥ng!", data.message, "success");
              setTimeout(() => location.reload(), 1000);
            })
            .catch((err) => {
              console.error("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ·∫©n:", err);
              Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b√¨nh lu·∫≠n!", "error");
            });
        });

        // ‚úÖ X√≥a b√¨nh lu·∫≠n
        $(document).on("click", ".delete-comment", function () {
          const commentId = $(this).attr("data-id");
          Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?",
            text: "B√¨nh lu·∫≠n n√†y s·∫Ω kh√¥ng th·ªÉ kh√¥i ph·ª•c!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "X√≥a ngay!",
            cancelButtonText: "H·ªßy",
          }).then((result) => {
            if (result.isConfirmed) {
              fetch(`/v1/dashboard/comment/delete/${commentId}`, {
                method: "DELETE",
              })
                .then((res) => res.json())
                .then((data) => {
                  Swal.fire("ƒê√£ x√≥a!", data.message, "success");
                  setTimeout(() => location.reload(), 1000);
                })
                .catch((err) => console.error(err));
            }
          });
        });

        $(document).on("click", ".view-comments-btn", function () {
          const commentId = $(this).data("comment-id");
          // G·ª≠i request l·∫•y danh s√°ch ph·∫£n h·ªìi
          fetch(`/v1/comment/replies/${commentId}`)
            .then((res) => res.json())
            .then((data) => {
              if (!data.comment) return;

              // Hi·ªÉn th·ªã n·ªôi dung b√¨nh lu·∫≠n
              $("#commentContent").html(
                `<strong>B√¨nh lu·∫≠n:</strong> ${data.comment.content}`
              );

              // Hi·ªÉn th·ªã danh s√°ch ph·∫£n h·ªìi
              let repliesHtml = "";
              if (data.comment.replies.length > 0) {
                data.comment.replies.forEach((reply) => {
                  repliesHtml += `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>‚Ü≥ <strong>${
                                          reply.userId?.name || "·∫®n danh"
                                        }:</strong> ${reply.content}</span>
                                        <button class="btn btn-danger btn-sm delete-reply" data-comment-id="${commentId}" data-reply-id="${
                    reply._id
                  }">
                                            üóë X√≥a
                                        </button>
                                    </li>`;
                });
              } else {
                repliesHtml =
                  "<li class='list-group-item text-muted'>Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o.</li>";
              }
              $("#replyList").html(repliesHtml);

              // L∆∞u commentId v√†o n√∫t g·ª≠i ph·∫£n h·ªìi
              $("#sendReply").data("comment-id", commentId);

              // Hi·ªÉn th·ªã modal
              $("#replyModal").modal("show");
            })
            .catch((err) => console.error(err));
        });

        $(document).on("click", ".btn-close, .btn-secondary", function () {
          $("#replyModal").modal("hide");
        });

        $(document).on("click", "#sendReply", function () {
          const commentId = $(this).data("comment-id");
          const replyContent = $("#replyContent").val().trim();

          if (!replyContent) {
            alert("Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi!");
            return;
          }

          fetch(`/v1/comment/replies/${commentId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              content: replyContent,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                $("#replyContent").val(""); // X√≥a n·ªôi dung nh·∫≠p v√†o
                alert("‚úÖ Ph·∫£n h·ªìi th√†nh c√¥ng!");
                fetchReplies(commentId); // Fetch l·∫°i danh s√°ch ph·∫£n h·ªìi
              } else {
                alert("‚ùå G·ª≠i ph·∫£n h·ªìi th·∫•t b·∫°i: " + data.message);
              }
            })
            .catch((err) => {
              console.error("‚ùå L·ªói khi g·ª≠i ph·∫£n h·ªìi:", err);
              alert("‚ùå C√≥ l·ªói x·∫£y ra!");
            });
        });

        // ‚úÖ X√≥a ph·∫£n h·ªìi
        $(document).on("click", ".delete-reply", function () {
          const replyId = $(this).attr("data-reply-id");
          const commentId = $(this).attr("data-comment-id");

          Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph·∫£n h·ªìi n√†y?",
            text: "Ph·∫£n h·ªìi s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "X√≥a ngay!",
            cancelButtonText: "H·ªßy",
          }).then((result) => {
            if (result.isConfirmed) {
              fetch(`/v1/dashboard/comment/reply/${commentId}/${replyId}`, {
                method: "DELETE",
              })
                .then((res) => res.json())
                .then((data) => {
                  Swal.fire("ƒê√£ x√≥a!", data.message, "success");
                  fetchReplies(commentId); // Fetch l·∫°i danh s√°ch ph·∫£n h·ªìi
                })
                .catch((err) => console.error(err));
            }
          });
        });

        // // ‚úÖ G·ª≠i y√™u c·∫ßu s·ª≠a ph·∫£n h·ªìi
        // $("#saveEditReply").click(function () {
        //     const replyId = $("#editReplyId").val();
        //     const commentId = $("#editCommentId").val();
        //     const newContent = $("#editReplyContent").val().trim();

        //     if (!newContent) {
        //         Swal.fire("L·ªói!", "Vui l√≤ng nh·∫≠p n·ªôi dung m·ªõi!", "error");
        //         return;
        //     }

        //     fetch(`/v1/dashboard/comment/reply/edit/${commentId}/${replyId}`, {
        //         method: "PATCH",
        //         headers: { "Content-Type": "application/json" },
        //         body: JSON.stringify({ content: newContent })
        //     })
        //         .then(res => res.json())
        //         .then(data => {
        //             if (data.message) {
        //                 Swal.fire("Th√†nh c√¥ng!", "Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!", "success");
        //                 $(`#reply-${replyId}`).find("td:eq(0)").html(`‚Ü≥ <strong>Ch·ªß c·ª≠a h√†ng:</strong> ${newContent}`);
        //                 $("#editReplyModal").modal("hide");
        //             }
        //         })
        //         .catch(err => {
        //             Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!", "error");
        //             console.error(err);
        //         });
        // });
      });

      function fetchReplies(commentId) {
        fetch(`/v1/comment/replies/${commentId}`)
          .then((res) => res.json())
          .then((data) => {
            if (!data.comment) return;

            let repliesHtml = "";
            if (data.comment.replies.length > 0) {
              data.comment.replies.forEach((reply) => {
                repliesHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center" id="reply-${
                          reply._id
                        }">
                            <span>‚Ü≥ <strong>${
                              reply.userId?.name || "·∫®n danh"
                            }:</strong> ${reply.content}</span>
                            <button class="btn btn-danger btn-sm delete-reply" data-comment-id="${commentId}" data-reply-id="${
                  reply._id
                }">
                                üóë X√≥a
                            </button>
                        </li>`;
              });
            } else {
              repliesHtml =
                "<li class='list-group-item text-muted'>Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o.</li>";
            }
            $("#replyList").html(repliesHtml);
          })
          .catch((err) =>
            console.error("‚ùå L·ªói khi l·∫•y danh s√°ch ph·∫£n h·ªìi:", err)
          );
      }
    </script>
    <!-- Script Chat (t∆∞∆°ng t·ª± code chat c≈©) -->
    <script>
      const socket = io();
      const adminId = "admin";
      const adminUsername = "Admin";

      let selectedUser = null;
      let messages = {};
      let unreadUsers = {};
      let notifications = [];

      const chatUserList = document.getElementById("chat-user-list");
      const chatTitle = document.getElementById("chat-title");
      const chatContainer = document.getElementById("chat");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-btn");
      const notificationBadge = document.getElementById("notif-badge");
      const notifHeader = document.getElementById("notif-header");
      const notifItems = document.getElementById("notif-items");
      const markAllBtn = document.getElementById("mark-all-read");

      // --- LocalStorage helpers ---
      function getReadIds() {
        return JSON.parse(localStorage.getItem("readNotifications") || "[]");
      }
      function addReadId(id) {
        const arr = getReadIds();
        if (!arr.includes(id)) {
          arr.push(id);
          localStorage.setItem("readNotifications", JSON.stringify(arr));
        }
      }

      // --- Socket registration ---
      socket.emit("register", {
        userId: adminId,
        username: adminUsername,
        isAuthenticated: true,
      });
 // Khi c√≥ th√¥ng b√°o m·ªõi t·ª´ server (qua socket)
      socket.on("newNotification", (notification) => {
        // Ki·ªÉm tra tr√πng (v√≠ d·ª• ki·ªÉm tra userId v√† timestamp)
        const exists = notifications.some(
          (n) =>
            n.userId === notification.userId &&
            new Date(n.timestamp).toISOString() ===
              new Date(notification.timestamp).toISOString()
        );
        if (!exists) {
          notifications.unshift(notification);
          updateBadge(); // c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
          renderDropdown(); // c·∫≠p nh·∫≠t giao di·ªán dropdown
        }
      });
      // --- Load & render notifications from server + localStorage flags ---
      async function loadNotifications() {
        const resp = await fetch("/v1/notifications");
        const notes = await resp.json();
        // s·ª≠ d·ª•ng ƒë√∫ng flag read t·ª´ server
        notifications = notes.map(n => ({
    _id:       n._id,
    userId:    n.userId,
    username:  n.username,
    timestamp: new Date(n.createdAt).toLocaleString("vi-VN"),
    read:      n.read
  }));
        updateBadgeAndHeader()
        renderNotificationDropdown();
      }
      loadNotifications();
      // th√™m notification m·ªõi: POST tr∆∞·ªõc, r·ªìi unshift k·∫øt qu·∫£
      async function addNotification(n) {
        try {
          const resp = await fetch("/v1/notifications", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: n.userId,
              username: n.username,
              title: "Tin nh·∫Øn m·ªõi",
              message: "B·∫°n c√≥ tin nh·∫Øn m·ªõi t·ª´ " + n.username,
              read: false,
            }),
          });
          const saved = await resp.json();
          // gi·ªù m·ªõi th√™m v√†o m·∫£ng
          notifications.unshift({
            _id: saved._id,
            userId: saved.userId,
            username: saved.username,
            timestamp: new Date(saved.createdAt).toLocaleString("vi-VN"),
            read: saved.read,
          });
          renderNotificationDropdown();
        } catch (err) {
          console.error("Failed to save notification:", err);
        }
      }

      // --- C·∫≠p nh·∫≠t badge v√† header ---
      function updateBadgeAndHeader() {
        const unread = notifications.filter((n) => !n.read).length;
        notificationBadge.innerText = unread > 0 ? unread : "";
        notifHeader.innerText = `${unread} Notifications`;
      }

      // render v√† g√°n click
      function renderNotificationDropdown() {
        const unread = notifications.filter((n) => !n.read).length;
        notificationBadge.innerText = unread > 0 ? unread : "";
        notifHeader.innerText = `${unread} Notifications`;
        notifItems.innerHTML = notifications
          .map(
            (n, i) => `
    <a href="#" class="dropdown-item ${n.read ? "" : "bg-light"}"
       data-index="${i}"
       data-id="${n._id}"
       data-user-id="${n.userId}"
       data-username="${n.username}">
      <i class="fas fa-envelope mr-2"></i>
      <strong>${n.username}</strong> ƒë√£ g·ª≠i tin nh·∫Øn m·ªõi
      <span class="float-right text-muted text-sm">${n.timestamp}</span>
    </a>
    <div class="dropdown-divider"></div>
  `
          )
          .join("");

        notifItems.querySelectorAll("a.dropdown-item").forEach((el) => {
          el.onclick = async (e) => {
            e.preventDefault();
            const idx = +el.dataset.index;
            const note = notifications[idx];
            const notifId = el.dataset.id;
            const userId = el.dataset.userId;
            const username = el.dataset.username;

            if (!note.read) {
              // ƒë√°nh d·∫•u tr√™n server
              await fetch(`/v1/notifications/${notifId}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ read: true }),
              });
              // c·∫≠p nh·∫≠t local
              note.read = true;
            }

            // chuy·ªÉn sang chat
            document
              .getElementById("chat-tab-btn")
              .addEventListener("click", () => {
                // 1) local update ngay l·∫≠p t·ª©c
                notifications.forEach((n) => (n.read = true));

                // 2) c·∫≠p nh·∫≠t badge + dropdown
                updateBadgeAndHeader();
                renderNotificationDropdown();

                // 3) sync l√™n server (PATCH) nh∆∞ng kh√¥ng block UI
                notifications
                  .filter((n) => n._id) // ch·ªâ nh·ªØng ƒë√£ c√≥ _id
                  .forEach((n) => {
                    fetch(`/v1/notifications/${n._id}`, {
                      method: "PATCH",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ read: true }),
                    }).catch(console.error);
                  });
              });
            document.getElementById("chat-tab-btn").click();
            selectUser(userId, username);
            selectUser(userId, username);
            renderNotificationDropdown();
          };
        });
      }
      // --- Chat user list & selection ---
      socket.on("updateUserList", (users) => {
        chatUserList.innerHTML = "<h3 class='mt-2'>User List</h3>";
        users
          .filter((u) => u.userId !== adminId)
          .forEach((u) => {
            const div = document.createElement("div");
            div.classList.add("user-item");
            div.dataset.id = u.userId;
            if (unreadUsers[u.userId]) div.classList.add("new-message");
            div.innerHTML = `<div class="user-info">${u.username}</div><button class="hide-btn">·∫®n</button>`;
            div.querySelector(".user-info").onclick = () =>
              selectUser(u.userId, u.username);
            div.querySelector(".hide-btn").onclick = () => {
              socket.emit("hideChatWithUser", u.userId);
              div.remove();
            };
            chatUserList.appendChild(div);
          });
      });

      async function markRead(idx) {
        try {
          const res = await fetch("/v1/notifications/markAsRead", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: notifications[idx]._id }),
          });
          if (!res.ok) throw new Error("Mark failed");
          const updated = await res.json();
          // S·ª¨A: l·∫•y lu√¥n tr·∫°ng th√°i read t·ª´ server ƒë·ªÉ ƒë·ªìng nh·∫•t
          notifications[idx].read = !!(updated.read ?? updated.isRead);
        } catch (e) {
          console.error("‚ùå markRead:", e);
          // n·∫øu l·ªói, v·∫´n gi·ªØ client-side l√† ƒë√£ ƒë·ªçc ƒë·ªÉ kh·ªèi nh·∫£y badge
          notifications[idx].read = true;
        }
        await loadNotifications(); // ƒë·∫£m b·∫£o ƒë·ªìng b·ªô d·ªØ li·ªáu
      }

      markAllBtn.onclick = async (e) => {
        e.preventDefault();
        try {
          const res = await fetch("/v1/notifications/mark-all-read", {
            method: "PUT",
          });
          if (!res.ok) throw new Error("Mark all failed");
          notifications.forEach((n) => (n.read = true));
          updateBadgeAndHeader();
          renderNotificationDropdown();
        } catch (e) {
          console.error("‚ùå mark-all-read:", e);
        }
      };
      function renderDropdown() {
        const unreadCount = notifications.filter((n) => !n.read).length;
        notifHeader.innerText = `${unreadCount} Notifications`;
        notifItems.innerHTML = notifications
          .map(
            (n, i) => `
      <a href="#" class="dropdown-item ${
        n.read ? "" : "bg-light"
      }" data-idx="${i}">
        <i class="fas fa-${
          n.type === "message"
            ? "envelope"
            : n.type === "comment"
            ? "comment"
            : "box"
        } mr-2"></i>
        <strong>${n.username}</strong> ${n.message}
        <span class="float-right text-muted text-sm">
          ${new Date(n.timestamp).toLocaleTimeString()}
        </span>
      </a>
      <div class="dropdown-divider"></div>
    `
          )
          .join("");

        notifItems.querySelectorAll("a.dropdown-item").forEach((el) => {
          el.onclick = async (e) => {
            e.preventDefault();
            const idx = +el.dataset.idx;
            if (!notifications[idx].read) {
              // g·ªçi API ƒë·ªÉ ƒë√°nh d·∫•u l√† ƒë√£ ƒë·ªçc
              await markRead(idx);
              // v√† load l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë·ªìng b·ªô
              await loadNotifications();
            }
            const n = notifications[idx];
            selectUser(n.userId, n.username);
          };
        });
      }

      async function selectUser(id, name) {
        selectedUser = id;
        chatTitle.innerText = `Chat v·ªõi ${name}`;
        chatContainer.innerHTML = "";
        delete unreadUsers[id];

        // B·ªè highlight new-message
        document
          .querySelector(`[data-id="${id}"]`)
          ?.classList.remove("new-message");

        // *** ƒë√°nh d·∫•u read ngay khi click user
        await markNotificationsReadForUser(id);

        // Hi·ªÉn th·ªã history n·∫øu ƒë√£ load
        if (messages[id]) renderMessages(id);
        // r·ªìi fetch th√™m n·∫øu c·∫ßn
        socket.emit("getMessages", id);
      }

      socket.on("chatHistory", ({ userId, messages: hist }) => {
        messages[userId] = hist;
        if (userId === selectedUser) renderMessages(userId);
      });

      async function markNotificationsReadForUser(userId) {
        // L·∫•y ra danh s√°ch c·∫ßn mark
        const toMark = notifications.filter(
          (n) => n.userId === userId && !n.read && n._id
        );
        if (toMark.length === 0) return;

        // -- 1) Optimistic update tr√™n client --
        toMark.forEach((n) => (n.read = true));
        updateBadgeAndHeader();
        renderNotificationDropdown();

        // -- 2) G·ª≠i PATCH song song ƒë·ªÉ sync server --
        try {
          await Promise.all(
            toMark.map((n) =>
              fetch(`/v1/notifications/${n._id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ read: true }),
              })
            )
          );
        } catch (err) {
          console.error("Failed to patch notifications:", err);
        }
      }

      socket.on("receivePrivateMessage", (data) => {
        const senderId = data.sender;
        const senderName =
          senderId === adminId ? adminUsername : data.senderName;
        const chatPartner = senderId === adminId ? selectedUser : senderId;

        messages[chatPartner] = messages[chatPartner] || [];
        messages[chatPartner].push({
          senderName,
          message: data.message,
          timestamp: Date.now(),
        });

        if (selectedUser === chatPartner) {
          displayMessage(senderName, data.message);
        } else {
          unreadUsers[chatPartner] = true;
          document
            .querySelector(`[data-id="${chatPartner}"]`)
            ?.classList.add("new-message");
          // th√™m notification
          addNotification({
            userId: senderId,
            username: senderName,
            timestamp: new Date().toLocaleString("vi-VN"),
          });
        }
      });

      // --- Th√™m notification m·ªõi c·∫£ front+API ---
      async function addNotification(n) {
        const local = { ...n, read: false, _id: null };
        notifications.unshift(local);
        updateBadgeAndHeader();
        renderNotificationDropdown();

        try {
          const resp = await fetch("/v1/notifications", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: n.userId,
              username: n.username,
              title: "Tin nh·∫Øn m·ªõi",
              message: "B·∫°n c√≥ tin nh·∫Øn m·ªõi t·ª´ " + n.username,
              read: false,
            }),
          });
          const saved = await resp.json();
          local._id = saved._id;
        } catch (err) {
          console.error("Failed to save notification:", err);
        }
      }

      // --- g·ª≠i tin nh·∫Øn t·ª´ admin ---
      sendButton.onclick = sendMessage;
      function sendMessage() {
        if (!selectedUser) return alert("Ch·ªçn m·ªôt user ƒë·ªÉ nh·∫Øn tin!");
        const msg = messageInput.value.trim();
        if (!msg) return;
        socket.emit("sendPrivateMessage", {
          sender: adminId,
          receiver: selectedUser,
          message: msg,
        });
        messages[selectedUser].push({
          senderName: adminUsername,
          message: msg,
          timestamp: Date.now(),
        });
        displayMessage(adminUsername, msg);
        messageInput.value = "";
      }

      function displayMessage(senderName, message) {
        const d = document.createElement("div");
        d.classList.add("message");
        d.innerHTML = `<strong>${senderName}:</strong> ${message}`;
        chatContainer.appendChild(d);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      function renderMessages(uid) {
        chatContainer.innerHTML = "";
        messages[uid].forEach((m) => displayMessage(m.senderName, m.message));
      }

      // toggle dropdown
      document
        .querySelector("#nav-notif .nav-link")
        .addEventListener("click", (e) => {
          e.preventDefault();
          const menu = document.querySelector("#notif-menu");
          menu.style.display =
            menu.style.display === "block" ? "none" : "block";
        });

      // initial load
      loadNotifications();
    </script>
       <script src="/socket.io/socket.io.js"></script>
       <script>
         window.__ADMIN_ID__ = "<%= adminId %>";
         window.__ADMIN_NAME__ = "<%= adminName %>";
       </script>
       <script src="../public/global-notification.js"></script>
  </body>
</html>
