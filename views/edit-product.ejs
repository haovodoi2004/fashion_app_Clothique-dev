<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ch·ªânh s·ª≠a s·∫£n ph·∫©m</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    .form-group { margin-bottom: 1.5rem; }
    .variant-images img { width: 60px; height: 60px; object-fit: cover; margin-right: 5px; border-radius: 5px; }
    .card-body { padding: 20px; }
    .image-list {
      list-style: none;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .image-list li {
      display: flex;
      align-items: center;
      gap: 5px;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
    }

    .variant-thumbnail {
      width: 50px; /* Hi·ªÉn th·ªã ·∫£nh nh·ªè */
      height: 50px;
      object-fit: cover;
      border-radius: 5px;
    }

    .delete-image-btn {
      background-color: red;
      color: white;
      border: none;
      padding: 3px 6px;
      cursor: pointer;
      border-radius: 3px;
    }
  </style>
</head>
<body class="hold-transition login-page"> 
  <div class="container mt-4">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h3>
      </div>
      <form action="/v1/product/update-product/<%= product._id %>" method="POST">
        <div class="card-body">
          <div class="form-group">
            <label for="name">T√™n s·∫£n ph·∫©m</label>
            <input type="text" id="name" name="name" class="form-control" value="<%= product.name %>" required>
          </div>
          <div class="form-group">
            <label for="description">M√¥ t·∫£ s·∫£n ph·∫©m</label>
            <textarea id="description" name="description" class="form-control" rows="4" required><%= product.description %></textarea>
          </div>
          <div class="form-group">
            <label for="category">Lo·∫°i s·∫£n ph·∫©m</label>
            <select id="category" name="category" class="form-control">
              <% if (categories.length > 0) { %>
                <% categories.forEach(category => { %>
                  <option value="<%= category._id %>" <%= product.category.toString() == category._id.toString() ? 'selected' : '' %>><%= category.name %></option>
                <% }) %>
              <% } else { %>
                <option disabled selected>Kh√¥ng c√≥ lo·∫°i s·∫£n ph·∫©m n√†o</option>
              <% } %>              
            </select>
          </div>
        </div>
        
        <div class="card-body">
          <h5 class="mb-3">Bi·∫øn th·ªÉ s·∫£n ph·∫©m</h5>
          <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addVariantModal">Th√™m bi·∫øn th·ªÉ</button>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Size</th>
                <th>M√†u</th>
                <th>Gi√° nh·∫≠p</th>
                <th>Gi√° b√°n</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>·∫¢nh</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
              <% product.variants.forEach(variant => { %>
                <tr>
                  <td><%= variant.size %></td>
                  <td><%= variant.color %></td>
                  <td><%= variant.importPrice %> VNƒê</td>
                  <td><%= variant.salePrice %> VNƒê</td>
                  <td><%= variant.stock %></td>
                  <td class="variant-images">
                    <% if (Array.isArray(variant.images) && variant.images.length > 0) { %>
                      <ul class="image-list">
                        <% variant.images.forEach(image => { %>
                          <li>
                            <img src="<%= image %>" alt="·∫¢nh bi·∫øn th·ªÉ" class="variant-thumbnail">
                            <button type="button" class="btn btn-danger btn-sm delete-image-btn" data-variant-id="<%= variant._id %>" data-image-url="<%= image %>">X</button>
                          </li>
                        <% }) %>
                      </ul>
                    <% } %>
                    <button type="button" class="btn btn-sm btn-primary add-image-btn" data-id="<%= variant._id %>">Th√™m ·∫£nh</button>
                  </td>                  
                  <td>
                    <button type="button" class="btn btn-warning btn-sm edit-btn" data-toggle="modal" data-target="#updateVariantModal" data-id="<%= variant._id %>" data-name="<%= variant.size %>" data-color="<%= variant.color %>" data-import-price="<%= variant.importPrice %>" data-sale-price="<%= variant.salePrice %>" data-stock="<%= variant.stock %>">
                      S·ª≠a
                    </button>
                    <!-- <button type="button" class="btn btn-danger btn-sm delete-variant" data-id="<%= variant._id %>">X√≥a</button> -->
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        
        <div class="card-footer text-center">
          <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
          <a href="/v1/dashboard/products" class="btn btn-secondary">H·ªßy</a>
        </div>
      </form>
    </div>
  </div>

<!-- Modal th√™m bi·∫øn th·ªÉ -->
<div class="modal fade" id="addVariantModal" tabindex="-1" aria-labelledby="addVariantLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addVariantLabel">Th√™m bi·∫øn th·ªÉ</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="variantForm">
          <!-- Dropdown ch·ªçn size -->
          <div class="form-group">
            <label for="variantSize">Size</label>
            <select id="variantSize" name="size" class="form-control" required>
              <option value="XXS">XXS</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
              <option value="XXXL">XXXL</option>
            </select>
          </div>

          <!-- Ch·ªçn m√†u b·∫±ng button -->
          <div class="form-group">
            <label>M√†u</label>
            <div id="colorOptions" class="d-flex flex-wrap">
              <input type="hidden" id="variantColor" name="color" required>
              <button type="button" class="color-btn" data-color="ƒê·ªè" style="background-color: red;"></button>
              <button type="button" class="color-btn" data-color="Xanh D∆∞∆°ng" style="background-color: blue;"></button>
              <button type="button" class="color-btn" data-color="Xanh L√°" style="background-color: green;"></button>
              <button type="button" class="color-btn" data-color="ƒêen" style="background-color: black;"></button>
              <button type="button" class="color-btn" data-color="Tr·∫Øng" style="background-color: white;"></button>
              <button type="button" class="color-btn" data-color="X√°m" style="background-color: gray;"></button>
              <button type="button" class="color-btn" data-color="V√†ng" style="background-color: yellow;"></button>
              <button type="button" class="color-btn" data-color="Cam" style="background-color: orange;"></button>
              <button type="button" class="color-btn" data-color="T√≠m" style="background-color: purple;"></button>
              <button type="button" class="color-btn" data-color="H·ªìng" style="background-color: pink;"></button>
              <button type="button" class="color-btn" data-color="N√¢u" style="background-color: brown;"></button>
              <button type="button" class="color-btn" data-color="Xanh D∆∞∆°ng ƒê·∫≠m" style="background-color: navy;"></button>
            </div>
          </div>

          <div class="form-group">
            <label for="variantImportPrice">Gi√° nh·∫≠p</label>
            <input type="number" id="variantImportPrice" name="importPrice" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="variantSalePrice">Gi√° b√°n</label>
            <input type="number" id="variantSalePrice" name="salePrice" class="form-control" required>
          </div>          
          <div class="form-group">
            <label for="variantStock">S·ªë l∆∞·ª£ng</label>
            <input type="number" id="variantStock" name="stock" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary">Th√™m</button>
        </form>
      </div>
    </div>
  </div>
</div>

  <!-- Modal ch·ªânh s·ª≠a bi·∫øn th·ªÉ -->
<div class="modal fade" id="editVariantModal" tabindex="-1" aria-labelledby="editVariantLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editVariantLabel">Ch·ªânh s·ª≠a bi·∫øn th·ªÉ</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editVariantForm">
          <!-- Tr∆∞·ªùng ·∫©n ƒë·ªÉ l∆∞u ID -->
          <input type="hidden" id="editVariantId" name="id">

          <!-- Dropdown ch·ªçn size -->
          <div class="form-group">
            <label for="editVariantSize">Size</label>
            <select id="editVariantSize" name="size" class="form-control" required>
              <option value="XXS">XXS</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
              <option value="XXXL">XXXL</option>
            </select>
          </div>

          <!-- Ch·ªçn m√†u b·∫±ng button -->
          <div class="form-group">
            <label>M√†u</label>
            <div id="editColorOptions" class="d-flex flex-wrap">
              <input type="hidden" id="editVariantColor" name="color" required>
              <button type="button" class="color-btn" data-color="ƒê·ªè" style="background-color: red;"></button>
              <button type="button" class="color-btn" data-color="Xanh D∆∞∆°ng" style="background-color: blue;"></button>
              <button type="button" class="color-btn" data-color="Xanh L√°" style="background-color: green;"></button>
              <button type="button" class="color-btn" data-color="ƒêen" style="background-color: black;"></button>
              <button type="button" class="color-btn" data-color="Tr·∫Øng" style="background-color: white;"></button>
              <button type="button" class="color-btn" data-color="X√°m" style="background-color: gray;"></button>
              <button type="button" class="color-btn" data-color="V√†ng" style="background-color: yellow;"></button>
              <button type="button" class="color-btn" data-color="Cam" style="background-color: orange;"></button>
              <button type="button" class="color-btn" data-color="T√≠m" style="background-color: purple;"></button>
              <button type="button" class="color-btn" data-color="H·ªìng" style="background-color: pink;"></button>
              <button type="button" class="color-btn" data-color="N√¢u" style="background-color: brown;"></button>
              <button type="button" class="color-btn" data-color="Xanh D∆∞∆°ng ƒê·∫≠m" style="background-color: navy;"></button>
            </div>
          </div>

          <div class="form-group">
            <label for="editVariantImportPrice">Gi√° nh·∫≠p</label>
            <input type="number" id="editVariantImportPrice" name="importPrice" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="editVariantSalePrice">Gi√° b√°n</label>
            <input type="number" id="editVariantSalePrice" name="salePrice" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="editVariantStock">S·ªë l∆∞·ª£ng</label>
            <input type="number" id="editVariantStock" name="stock" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
        </form>
      </div>
    </div>
  </div>
</div>

  <div class="modal fade" id="uploadImageModal" tabindex="-1" aria-labelledby="uploadImageLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadImageLabel">Th√™m ·∫£nh cho bi·∫øn th·ªÉ</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="uploadImageForm">
            <input type="file" id="variantImage" accept="image/*" required>
            <button type="submit" class="btn btn-primary">T·∫£i l√™n</button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Th√™m CSS ƒë·ªÉ hi·ªÉn th·ªã m√†u ƒë·∫πp h∆°n -->
  <style>
    .color-btn {
      width: 35px;
      height: 35px;
      border: 3px solid black;
      border-radius: 50%;
      margin: 5px;
      cursor: pointer;
      transition: 0.2s;
      position: relative;
    }

    .color-btn.selected {
      box-shadow: 0 8px 0 gray; /* G·∫°ch ch√¢n xa h∆°n */
    }
  
    .d-flex.flex-wrap {
      gap: 5px;
    }
  </style>

  <script>
    document.querySelectorAll('.color-btn').forEach(button => {
      button.addEventListener('click', function () {
        document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('variantColor').value = this.dataset.color;
      });
    });

    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".delete-image-btn").forEach(button => {
        button.addEventListener("click", async function () {
          const variantId = this.dataset.variantId;
          const imageUrl = this.dataset.imageUrl;
          
          if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?")) return;

          try {
            const response = await fetch("/v1/variant/delete-image", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ variantId, imageUrl }),
            });

            const result = await response.json();
            if (response.ok) {
              alert("X√≥a ·∫£nh th√†nh c√¥ng!");
              this.parentElement.remove(); // X√≥a ·∫£nh tr√™n giao di·ªán
            } else {
              alert(result.message || "X√≥a ·∫£nh th·∫•t b·∫°i!");
            }
          } catch (error) {
            console.error("L·ªói khi x√≥a ·∫£nh:", error);
            alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a ·∫£nh!");
          }
        });
      });
    });

  </script>
  <script>
    $(document).on("click", ".add-image-btn", function () {
      const variantId = $(this).data("id");
      $("#uploadImageModal").data("variant-id", variantId).modal("show");
    });

    $("#uploadImageForm").submit(function (event) {
      event.preventDefault();
      
      let formData = new FormData();
      let file = $("#variantImage")[0].files[0];
      if (!file) {
        alert("Vui l√≤ng ch·ªçn ·∫£nh!");
        return;
      }

      formData.append("image", file);
      const variantId = $("#uploadImageModal").data("variant-id");
      console.log(variantId);
      
      $.ajax({
        url: `/v1/variant/upload-image/${variantId}`,
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          alert("·∫¢nh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n!");
          location.reload();
        },
        error: function (xhr) {
          alert("L·ªói khi t·∫£i ·∫£nh: " + (xhr.responseJSON?.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
        },
      });
    });

    // Hi·ªÉn th·ªã ·∫£nh xem tr∆∞·ªõc khi t·∫£i l√™n
    $("#variantImages").change(function(event) {
      $("#imagePreview").empty();
      for (let file of event.target.files) {
        let reader = new FileReader();
        reader.onload = function(e) {
          $("#imagePreview").append(`<img src="${e.target.result}" class="variant-images">`);
        };
        reader.readAsDataURL(file);
      }
    });

    // X√≥a bi·∫øn th·ªÉ
    $(".delete-variant").click(function() {
      let variantId = $(this).data("id");
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a bi·∫øn th·ªÉ n√†y?")) {
        $.ajax({
          url: "/v1/variant/" + variantId,
          type: "DELETE",
          success: function() {
            alert("ƒê√£ x√≥a bi·∫øn th·ªÉ!");
            location.reload();
          },
          error: function(xhr) {
            alert("L·ªói khi x√≥a: " + xhr.responseText);
          }
        });
      }
    });

    $(document).ready(function () {
  $(".edit-btn").click(function () {
    let id = $(this).data("id");
    let size = $(this).data("name");
    let color = $(this).data("color");
    let importPrice = $(this).data("import-price");
    let salePrice = $(this).data("sale-price");
    let stock = $(this).data("stock");

    $("#editVariantId").val(id);
    $("#editVariantSize").val(size);
    $("#editVariantColor").val(color);
    $("#editVariantImportPrice").val(importPrice);
    $("#editVariantSalePrice").val(salePrice);
    $("#editVariantStock").val(stock);

    $(".color-btn").removeClass("selected");
    $(`.color-btn[data-color="${color}"]`).addClass("selected");

    $("#editVariantModal").modal("show");
  });
});


    $("#addVariantModal").on("hidden.bs.modal", function () {
    // X√≥a h·∫øt d·ªØ li·ªáu trong c√°c input
    $(this).find("input").val("");

    // X√≥a class "selected" kh·ªèi c√°c n√∫t m√†u
    $(".color-btn").removeClass("selected");
  });

  $(document).ready(function () {
    $("#editVariantForm").submit(function (event) {
      const variantId = $("#editVariantId").val();

      // L·∫•y d·ªØ li·ªáu t·ª´ form
      let variantData = {
        size: $("#editVariantSize").val(),
        color: $("#editVariantColor").val(),
        importPrice: parseFloat($("#editVariantImportPrice").val()),
        salePrice: parseFloat($("#editVariantSalePrice").val()),
        stock: parseInt($("#editVariantStock").val()),
      };


      // G·ª≠i API c·∫≠p nh·∫≠t bi·∫øn th·ªÉ
      $.ajax({
        url: `/v1/variant/${variantId}`,  // üîπ Thay b·∫±ng API th·ª±c t·∫ø c·ªßa Aruji-sama
        type: "PUT",                  // üîπ Ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t d·ªØ li·ªáu
        contentType: "application/json",
        data: JSON.stringify(variantData),
        success: function (response) {
          alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");

          location.reload();
        },
        error: function (xhr) {
          // Hi·ªÉn th·ªã l·ªói t·ª´ server (n·∫øu c√≥)
          let errorMessage = xhr.responseJSON?.message || "C√≥ l·ªói x·∫£y ra!";
          alert("L·ªói: " + errorMessage);
        },
      });
    });
  });



  $("#variantForm").submit(function(e) {
    e.preventDefault();
    let formData = {
      productId: "<%= product._id %>",
      size: $("#variantSize").val(),
      color: $("#variantColor").val(),
      importPrice: $("#variantImportPrice").val(),
      salePrice: $("#variantSalePrice").val(),
      stock: $("#variantStock").val()
    };
    console.log(formData);
    
    $.post("/v1/variant/", formData, function(response) {
      alert("Th√™m bi·∫øn th·ªÉ th√†nh c√¥ng!");
      location.reload();
    }).fail(function(xhr) {
      alert("L·ªói khi th√™m bi·∫øn th·ªÉ: " + xhr.responseText);
    });
  });

  </script>
  <script>
    const socket = io();
    let selectedUser = null;
    let selectedUsername = "";
    let messages = {};
    let unreadUsers = {};
    let notifications = [];
    let unreadCount = 0;

    const adminId = "admin";
    const adminUsername = "Admin";

    const chatUserList = document.getElementById("chat-user-list");
    const chatTitle = document.getElementById("chat-title");
    const chatContainer = document.getElementById("chat");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-btn");

    const notificationBadge = document.getElementById("notif-badge");
    const notifItems = document.getElementById("notif-items");

    function getReadIds() {
      return JSON.parse(localStorage.getItem("readNotifications") || "[]");
    }
    function addReadId(id) {
      const arr = getReadIds();
      if (!arr.includes(id)) {
        arr.push(id);
        localStorage.setItem("readNotifications", JSON.stringify(arr));
      }
    }

    socket.emit("register", {
      userId: adminId,
      username: adminUsername,
      isAuthenticated: true,
    });
 // Khi c√≥ th√¥ng b√°o m·ªõi t·ª´ server (qua socket)
      socket.on("newNotification", (notification) => {
        // Ki·ªÉm tra tr√πng (v√≠ d·ª• ki·ªÉm tra userId v√† timestamp)
        const exists = notifications.some(
          (n) =>
            n.userId === notification.userId &&
            new Date(n.timestamp).toISOString() ===
              new Date(notification.timestamp).toISOString()
        );
        if (!exists) {
          notifications.unshift(notification);
          updateBadge(); // c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
          renderDropdown(); // c·∫≠p nh·∫≠t giao di·ªán dropdown
        }
      });
    function renderUserList(userArray) {
      chatUserList.innerHTML = "<h3 class='mt-2'>User List</h3>";
      userArray.forEach((userObj) => {
        if (userObj.userId !== adminId) {
          const userItem = createUserListItem(userObj);
          chatUserList.appendChild(userItem);
        }
      });
    }
    function renderDropdown() {
      const unreadCount = notifications.filter((n) => !n.read).length;
      notifHeader.innerText = `${unreadCount} Notifications`;
      notifItems.innerHTML = notifications
        .map(
          (n, i) => `
    <a href="#" class="dropdown-item ${
      n.read ? "" : "bg-light"
    }" data-idx="${i}" data-userid="${n.userId}">
      <i class="fas fa-envelope mr-2"></i>
      <strong>${n.username}</strong> C√≥ tin nh·∫Øn m·ªõi
      <span class="float-right text-muted text-sm">
        ${new Date(n.timestamp).toLocaleTimeString()}
      </span>
    </a>
    <div class="dropdown-divider"></div>
  `
        )
        .join("");

      notifItems.querySelectorAll("a.dropdown-item").forEach((el) => {
        el.onclick = async (e) => {
          e.preventDefault();
          const idx = +el.dataset.idx;
          const userId = el.dataset.userid;
          if (!notifications[idx].read) {
            // g·ªçi API
            await markRead(idx);
            // v√† load l·∫°i ƒë·ªÉ ch·∫Øc ch·∫Øn badge gi·∫£m, server ƒë·ªìng b·ªô
            await loadNotifications();
          }
          // Chuy·ªÉn t·ªõi m√†n chat t∆∞∆°ng ·ª©ng
          selectUser(userId, notifications[idx].username);
        };
      });
    }

    function createUserListItem(userObj) {
      const userItem = document.createElement("div");
      userItem.classList.add("user-item");
      userItem.dataset.id = userObj.userId;
      userItem.innerHTML = `
<div class="user-info">${userObj.username}</div>
<button class="hide-btn">·∫®n</button>
`;
      if (unreadUsers[userObj.userId]) {
        userItem.classList.add("new-message");
      }
      userItem.querySelector(".user-info").addEventListener("click", () => {
        selectUser(userObj.userId, userObj.username);
      });
      userItem.querySelector(".hide-btn").addEventListener("click", () => {
        socket.emit("hideChatWithUser", userObj.userId);
        userItem.remove();
      });
      return userItem;
    }

    socket.on("updateUserList", renderUserList);
    function selectUser(id, name) {
      selectedUser = id;
      chatTitle.innerText = `Chat v·ªõi ${name}`;
      chatContainer.innerHTML = "";
      delete unreadUsers[id];
      const ui = document.querySelector(`[data-id="${id}"]`);
      if (ui) ui.classList.remove("new-message");
      if (messages[id]) renderMessages(id);
      // ƒê·∫∑t c·ªù tr∆∞·ªõc khi l·∫•y tin nh·∫Øn t·ª´ server
      isReloadingMessages = true;
      socket.emit("getMessages", id); // G·ª≠i y√™u c·∫ßu l·∫•y tin nh·∫Øn l·ªãch s·ª≠
    }

    socket.on("chatHistory", ({ userId, messages: hist }) => {
      messages[userId] = hist;
      if (userId === selectedUser) renderMessages(userId);
    });

    socket.on("receivePrivateMessage", (data) => {
      const senderId = data.sender;
      const senderName =
        senderId === adminId ? adminUsername : data.senderName || senderId;
      const chatPartner = senderId === adminId ? selectedUser : senderId;

      if (!messages[chatPartner]) messages[chatPartner] = [];
      messages[chatPartner].push({
        senderName,
        message: data.message,
        timestamp: Date.now(),
      });

      if (selectedUser === chatPartner) {
        displayMessage(senderName, data.message);
      } else {
        unreadUsers[chatPartner] = true;
        document
          .querySelector(`[data-id="${chatPartner}"]`)
          ?.classList.add("new-message");
        addNotification({
          userId: senderId,
          username: senderName,
          timestamp: new Date().toLocaleTimeString(),
        });
      }
    });

    async function addNotification(n) {
      const local = { ...n, read: false, _id: null };
      notifications.unshift(local);
      updateBadge();
      renderNotificationDropdown();
      try {
        const resp = await fetch("/v1/notifications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: n.userId,
            username: n.username,
            title: "Tin nh·∫Øn m·ªõi",
            message: "B·∫°n c√≥ tin nh·∫Øn m·ªõi t·ª´ " + n.username,
            read: false,
          }),
        });
        const saved = await resp.json();
        local._id = saved._id;
      } catch (err) {
        console.error("Failed to save notification:", err);
      }
    }

    function updateBadge() {
      unreadCount = notifications.filter((x) => !x.read).length;
      notificationBadge.innerText = unreadCount > 0 ? unreadCount : "";
    }

    function renderNotificationDropdown() {
      let html = `<span class="dropdown-item dropdown-header">${unreadCount} Notifications</span><div class="dropdown-divider"></div>`;
      notifications.forEach((n, i) => {
        const cls = n.read ? "" : "bg-light";
        html += `
    <a href="#" class="dropdown-item ${cls}" data-index="${i}" data-user-id="${n.userId}" data-username="${n.username}">
      <i class="fas fa-envelope mr-2"></i>
      <strong>${n.username}</strong> ƒë√£ g·ª≠i tin nh·∫Øn m·ªõi
      <span class="float-right text-muted text-sm">${n.timestamp}</span>
    </a><div class="dropdown-divider"></div>`;
      });
      html += `<a href="/notifications" class="dropdown-item dropdown-footer">See All</a>`;
      notifItems.innerHTML = html;

      // X·ª≠ l√Ω khi click v√†o th√¥ng b√°o
      notifItems.querySelectorAll("a.dropdown-item").forEach((el) => {
        const idx = parseInt(el.dataset.index, 10);
        const note = notifications[idx];
        el.addEventListener("click", async (e) => {
          e.preventDefault();

          // ƒê√°nh d·∫•u th√¥ng b√°o l√† ƒë√£ ƒë·ªçc
          if (!note.read) {
            try {
              await fetch(`/v1/notifications/${note._id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ read: true }),
              });
              note.read = true;
              addReadId(note._id); // L∆∞u l·∫°i ID th√¥ng b√°o ƒë√£ ƒë·ªçc
              updateBadge();
              renderNotificationDropdown();
            } catch (err) {
              console.error("Failed to mark as read", err);
            }
          }

          // Chuy·ªÉn h∆∞·ªõng t·ªõi m√†n chat c·ªßa user
          window.location.href = `/admin/chat?userId=${el.dataset.userId}&username=${el.dataset.username}`;

          // Ti·∫øn h√†nh ch·ªçn ng∆∞·ªùi d√πng trong chat
          selectUser(el.dataset.userId, el.dataset.username);
        });
      });
    }

    async function loadNotifications() {
      try {
        const resp = await fetch("/v1/notifications");
        const notes = await resp.json();
        console.log("D·ªØ li·ªáu t·ª´ API /v1/notifications:", notes);
        const readIds = getReadIds();
        notifications = notes.map((n) => {
          let formattedTime = "Kh√¥ng x√°c ƒë·ªãnh";
          if (n.createdAt && !isNaN(new Date(n.createdAt))) {
            formattedTime = new Date(n.createdAt).toLocaleString("vi-VN");
          }

          return {
            userId: n.userId,
            username: n.username,
            timestamp: formattedTime,
            read: n.read || readIds.includes(n._id),
            _id: n._id,
          };
        });
        updateBadge();
        renderNotificationDropdown();
      } catch (err) {
        console.error("Load notifications failed", err);
      }
    }

    function sendMessage() {
      if (!selectedUser) return alert("Ch·ªçn m·ªôt user ƒë·ªÉ nh·∫Øn tin!");
      const msg = messageInput.value.trim();
      if (!msg) return;
      socket.emit("sendPrivateMessage", {
        sender: adminId,
        receiver: selectedUser,
        message: msg,
      });
      messages[selectedUser] = messages[selectedUser] || [];
      messages[selectedUser].push({
        senderName: adminUsername,
        message: msg,
        timestamp: Date.now(),
      });
      displayMessage(adminUsername, msg);
      messageInput.value = "";
    }

    function displayMessage(senderName, message) {
      const d = document.createElement("div");
      d.classList.add("message");
      d.innerHTML = `<strong>${senderName}:</strong> ${message}`;
      chatContainer.appendChild(d);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderMessages(uid) {
      chatContainer.innerHTML = "";
      messages[uid].forEach((m) => displayMessage(m.senderName, m.message));
    }

    loadNotifications();
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    window.__ADMIN_ID__ = "<%= adminId %>";
    window.__ADMIN_NAME__ = "<%= adminName %>";
  </script>
  <script src="../public/global-notification.js"></script>
</body>
</html>
